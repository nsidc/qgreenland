version: "3.4"

services:

  # Luigi runs as a service and must have jobs submitted to it
  # (`scripts/run.sh`)
  luigi:
    image: "nsidc/qgreenland:${QGREENLAND_VERSION:?QGREENLAND_VERSION must be set}"
    container_name: "luigi"
    volumes:
      # Code
      - "./:/luigi/tasks/qgreenland:ro"
      # Luigi artifacts
      - "./luigi/conf:/etc/luigi:ro"
      - "./luigi/state:/luigi/state:rw"

      # Input (private) storage
      - "${QGREENLAND_DATA_PRIVATE_ARCHIVE:-./data/private-archive}:/private-archive:ro"
      # Read-write storage
      # HACK: Should use ${QGREENLAND_DATA_WORKING_STORAGE}, but we were having
      # issues with our storage appliance some time ago, started using two
      # working storage locations temporarily, and we haven't re-tested yet.
      - "${QGREENLAND_DATA_WORKING_STORAGE_TMP:-./data/working-storage}:/working-storage:rw"
    environment:
      - "QGREENLAND_EARTHDATA_USERNAME=${QGREENLAND_EARTHDATA_USERNAME:?QGREENLAND_EARTHDATA_USERNAME must be set}"
      - "QGREENLAND_EARTHDATA_PASSWORD=${QGREENLAND_EARTHDATA_PASSWORD:?QGREENLAND_EARTHDATA_PASSWORD must be set}"
      - "QGREENLAND_ENVIRONMENT"
      - "QGREENLAND_ENV_MANAGER=micromamba"
      # Configure Luigi to find its config in luigi/conf/luigi.toml
      - "LUIGI_CONFIG_PARSER=toml"
      # Set `export PYTHONBREAKPOINT=ipdb.set_trace` to use `ipdb` by default
      # instead of `pdb`.
      - "PYTHONBREAKPOINT"
      # Needed to properly initialize QGIS Python library without a display
      - "QT_QPA_PLATFORM=minimal"
    ports:
      - "8082:8082"
    logging:
      options:
        max-size: "20m"
        max-file: "5"
    restart: "on-failure"


  # QGreenland hosting
  webserver:
    image: "nsidc/nginx:local"
    build: "./nginx"
    container_name: "webserver"
    volumes:
      - "./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro"
      - "./nginx/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "${QGREENLAND_DATA_WORKING_STORAGE:-./data/working-storage}/release-layers:/usr/share/nginx/html/layers:ro"
      - "${QGREENLAND_DATA_WORKING_STORAGE:-./data/working-storage}/release-packages:/usr/share/nginx/html/packages:ro"
      - "${QGREENLAND_DATA_LOGS:-./data/logs}:/logs:rw"
    ports:
      - "80:80"
      - "443:443"
    logging:
      options:
        max-size: "20m"
        max-file: "5"
    restart: "on-failure"
